<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°é’±åŒ…ç®¡ç†æµ‹è¯• - é—²ç‹—è”åˆä¼š</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            font-family: 'Arial', sans-serif;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }
        .page-header h1 {
            color: #00ff88;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .member-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 1px solid #00ff88;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
            transition: transform 0.3s ease;
        }
        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.4);
        }
        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
        }
        .member-name {
            color: #00ff88;
            font-size: 1.3rem;
            font-weight: bold;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-active {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px 0;
        }
        .label {
            color: #888;
            font-weight: 500;
        }
        .value {
            color: #ffffff;
            font-weight: bold;
        }
        .wallet-balance {
            color: #00ff88;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .member-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 255, 136, 0.2);
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #00cc6a 0%, #00ff88 100%);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        .loading {
            text-align: center;
            color: #00ff88;
            font-size: 1.2rem;
            margin: 50px 0;
        }
        .error {
            color: #ff4444;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            border-radius: 8px;
        }
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 255, 136, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #00ff88;
            display: block;
        }
        .stat-label {
            color: #888;
            font-size: 0.9rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>ğŸ’° åå°é’±åŒ…ç®¡ç†</h1>
            <p>å®æ—¶æŸ¥çœ‹ä¼šå‘˜é’±åŒ…ä½™é¢å’Œäº¤æ˜“è®°å½•</p>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-number" id="totalMembers">0</span>
                <div class="stat-label">æ€»ä¼šå‘˜æ•°</div>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="activeWallets">0</span>
                <div class="stat-label">æ´»è·ƒé’±åŒ…</div>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="totalBalance">Â¥0.00</span>
                <div class="stat-label">æ€»ä½™é¢</div>
            </div>
        </div>

        <div id="loadingMessage" class="loading">æ­£åœ¨åŠ è½½ä¼šå‘˜é’±åŒ…ä¿¡æ¯...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="membersContainer" class="members-grid" style="display: none;"></div>
    </div>

    <script src="js/api-client.js"></script>
    <script>
        class WalletAdmin {
            constructor() {
                this.members = [];
                this.walletData = new Map();
                this.init();
            }

            async init() {
                try {
                    await this.loadMembers();
                    await this.loadWalletData();
                    this.renderMembers();
                    this.updateStats();
                    this.hideLoading();
                } catch (error) {
                    this.showError('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
                }
            }

            async loadMembers() {
                try {
                    const result = await apiClient.getMembers();
                    this.members = Array.isArray(result) ? result : [];
                } catch (error) {
                    console.error('è·å–ä¼šå‘˜åˆ—è¡¨å¤±è´¥:', error);
                    throw error;
                }
            }

            async loadWalletData() {
                for (const member of this.members) {
                    try {
                        const walletResult = await apiClient.getWallet(member.id);
                        if (walletResult.success) {
                            this.walletData.set(member.id, walletResult.wallet);
                        }
                    } catch (error) {
                        console.error(`è·å–ä¼šå‘˜ ${member.username} é’±åŒ…å¤±è´¥:`, error);
                        this.walletData.set(member.id, { balance: 0 });
                    }
                }
            }

            renderMembers() {
                const container = document.getElementById('membersContainer');
                if (this.members.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888;">æš‚æ— ä¼šå‘˜æ•°æ®</p>';
                    return;
                }

                const membersHTML = this.members.map(member => {
                    const wallet = this.walletData.get(member.id) || { balance: 0 };
                    const joinDate = new Date(member.joined_at).toLocaleDateString('zh-CN');
                    
                    return `
                        <div class="member-card">
                            <div class="member-header">
                                <div class="member-name">${member.username || 'æœªçŸ¥ç”¨æˆ·'}</div>
                                <div class="status-badge status-active">æ´»è·ƒ</div>
                            </div>
                            <div class="member-info">
                                <div class="info-row">
                                    <span class="label">ç”¨æˆ·ID:</span>
                                    <span class="value">${member.id}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">é‚®ç®±:</span>
                                    <span class="value">${member.email || '-'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">æ‰‹æœº:</span>
                                    <span class="value">${member.phone || '-'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">åŸå¸‚:</span>
                                    <span class="value">${member.city || '-'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">æ³¨å†Œæ—¶é—´:</span>
                                    <span class="value">${joinDate}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">é’±åŒ…ä½™é¢:</span>
                                    <span class="value wallet-balance">Â¥${wallet.balance.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="member-actions">
                                <button class="btn btn-primary" onclick="walletAdmin.viewTransactions('${member.id}')">
                                    æŸ¥çœ‹äº¤æ˜“è®°å½•
                                </button>
                                <button class="btn btn-secondary" onclick="walletAdmin.viewDetails('${member.id}')">
                                    æŸ¥çœ‹è¯¦æƒ…
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = membersHTML;
            }

            updateStats() {
                const totalMembers = this.members.length;
                const activeWallets = Array.from(this.walletData.values()).filter(w => w.balance > 0).length;
                const totalBalance = Array.from(this.walletData.values()).reduce((sum, wallet) => sum + wallet.balance, 0);

                document.getElementById('totalMembers').textContent = totalMembers;
                document.getElementById('activeWallets').textContent = activeWallets;
                document.getElementById('totalBalance').textContent = `Â¥${totalBalance.toFixed(2)}`;
            }

            async viewTransactions(memberId) {
                try {
                    const member = this.members.find(m => m.id === memberId);
                    const result = await apiClient.getWalletTransactions(memberId);
                    
                    if (result.success && result.transactions.length > 0) {
                        const transactionList = result.transactions.map(tx => {
                            const date = new Date(tx.created_at).toLocaleString('zh-CN');
                            const typeText = tx.type === 'deposit' ? 'ğŸ’° å……å€¼' : 'ğŸ’¸ ææ¬¾';
                            const amountColor = tx.type === 'deposit' ? '#00ff88' : '#ff4444';
                            const sign = tx.type === 'deposit' ? '+' : '-';
                            
                            return `ğŸ“… ${date} | ${typeText} | ${sign}Â¥${tx.amount.toFixed(2)} | ${tx.description || ''}`;
                        }).join('\n');
                        
                        alert(`ä¼šå‘˜ ${member.username} çš„äº¤æ˜“è®°å½•:\n\n${transactionList}`);
                    } else {
                        alert(`ä¼šå‘˜ ${member.username} æš‚æ— äº¤æ˜“è®°å½•`);
                    }
                } catch (error) {
                    alert('è·å–äº¤æ˜“è®°å½•å¤±è´¥: ' + error.message);
                }
            }

            viewDetails(memberId) {
                const member = this.members.find(m => m.id === memberId);
                const wallet = this.walletData.get(memberId) || { balance: 0 };
                
                const details = `
ä¼šå‘˜è¯¦ç»†ä¿¡æ¯:

ğŸ” åŸºæœ¬ä¿¡æ¯:
â€¢ ç”¨æˆ·å: ${member.username}
â€¢ ç”¨æˆ·ID: ${member.id}
â€¢ é‚®ç®±: ${member.email || 'æœªè®¾ç½®'}
â€¢ æ‰‹æœº: ${member.phone || 'æœªè®¾ç½®'}
â€¢ åŸå¸‚: ${member.city || 'æœªè®¾ç½®'}
â€¢ æ³¨å†Œæ—¶é—´: ${new Date(member.joined_at).toLocaleString('zh-CN')}

ğŸ’° é’±åŒ…ä¿¡æ¯:
â€¢ å½“å‰ä½™é¢: Â¥${wallet.balance.toFixed(2)}
â€¢ é’±åŒ…åˆ›å»ºæ—¶é—´: ${wallet.created_at ? new Date(wallet.created_at).toLocaleString('zh-CN') : 'æœªçŸ¥'}
                `;
                
                alert(details);
            }

            hideLoading() {
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('membersContainer').style.display = 'grid';
            }

            showError(message) {
                document.getElementById('loadingMessage').style.display = 'none';
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        // åˆå§‹åŒ–é’±åŒ…ç®¡ç†
        const walletAdmin = new WalletAdmin();
    </script>
</body>
</html>