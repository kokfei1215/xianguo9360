<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç«™åŠŸèƒ½ç»¼åˆæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-item {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #ddd;
            background: #fafafa;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .info { border-left-color: #17a2b8; background: #d1ecf1; }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover { background: #0056b3; }
        .result { margin-top: 10px; font-size: 14px; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px;
            padding: 10px; 
            margin-top: 10px; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        h1, h2 { color: #333; }
        .critical { background: #ffebee; border: 2px solid #f44336; }
        .major { background: #fff3e0; border: 2px solid #ff9800; }
        .minor { background: #f3e5f5; border: 2px solid #9c27b0; }
    </style>
</head>
<body>
    <h1>ğŸ› ç½‘ç«™åŠŸèƒ½ç»¼åˆæµ‹è¯•ä¸Bugæ£€æŸ¥</h1>
    
    <div class="stats">
        <div class="stat-item">
            <div class="stat-number" id="totalTests">0</div>
            <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="passedTests">0</div>
            <div class="stat-label">é€šè¿‡æµ‹è¯•</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="failedTests">0</div>
            <div class="stat-label">å¤±è´¥æµ‹è¯•</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="bugsFound">0</div>
            <div class="stat-label">å‘ç°Bug</div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ æœåŠ¡å™¨è¿æ¥æµ‹è¯•</h2>
        <button onclick="testServerConnection()">æµ‹è¯•æœåŠ¡å™¨è¿æ¥</button>
        <button onclick="testAllAPIs()">æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹</button>
        <div id="serverTestResults" class="result"></div>
    </div>

    <div class="test-grid">
        <div class="test-section">
            <h2>ğŸ‘¤ ç”¨æˆ·è®¤è¯æµ‹è¯•</h2>
            <div class="test-item">
                <strong>ä¼šå‘˜ç™»å½•æµ‹è¯•</strong>
                <button onclick="testMemberLogin()">æµ‹è¯•ä¼šå‘˜ç™»å½•</button>
                <div id="memberLoginResult" class="result"></div>
            </div>
            <div class="test-item">
                <strong>ç®¡ç†å‘˜ç™»å½•æµ‹è¯•</strong>
                <button onclick="testAdminLogin()">æµ‹è¯•ç®¡ç†å‘˜ç™»å½•</button>
                <div id="adminLoginResult" class="result"></div>
            </div>
            <div class="test-item">
                <strong>ä¼šè¯éªŒè¯æµ‹è¯•</strong>
                <button onclick="testSessionValidation()">æµ‹è¯•ä¼šè¯éªŒè¯</button>
                <div id="sessionValidationResult" class="result"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ’° é’±åŒ…åŠŸèƒ½æµ‹è¯•</h2>
            <div class="test-item">
                <strong>é’±åŒ…æŸ¥è¯¢æµ‹è¯•</strong>
                <button onclick="testWalletQuery()">æµ‹è¯•é’±åŒ…æŸ¥è¯¢</button>
                <div id="walletQueryResult" class="result"></div>
            </div>
            <div class="test-item">
                <strong>é’±åŒ…å……å€¼æµ‹è¯•</strong>
                <button onclick="testWalletDeposit()">æµ‹è¯•é’±åŒ…å……å€¼</button>
                <div id="walletDepositResult" class="result"></div>
            </div>
            <div class="test-item">
                <strong>äº¤æ˜“è®°å½•æµ‹è¯•</strong>
                <button onclick="testTransactionHistory()">æµ‹è¯•äº¤æ˜“è®°å½•</button>
                <div id="transactionHistoryResult" class="result"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ‘¥ ä¼šå‘˜ç®¡ç†æµ‹è¯•</h2>
            <div class="test-item">
                <strong>ä¼šå‘˜åˆ—è¡¨æµ‹è¯•</strong>
                <button onclick="testMemberList()">æµ‹è¯•ä¼šå‘˜åˆ—è¡¨</button>
                <div id="memberListResult" class="result"></div>
            </div>
            <div class="test-item">
                <strong>ä¼šå‘˜æ³¨å†Œæµ‹è¯•</strong>
                <button onclick="testMemberRegistration()">æµ‹è¯•ä¼šå‘˜æ³¨å†Œ</button>
                <div id="memberRegistrationResult" class="result"></div>
            </div>
            <div class="test-item">
                <strong>å¯†ç ä¿®æ”¹æµ‹è¯•</strong>
                <button onclick="testPasswordChange()">æµ‹è¯•å¯†ç ä¿®æ”¹</button>
                <div id="passwordChangeResult" class="result"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ” æ•°æ®ä¸€è‡´æ€§æµ‹è¯•</h2>
            <div class="test-item">
                <strong>æ•°æ®åŒæ­¥æµ‹è¯•</strong>
                <button onclick="testDataSync()">æµ‹è¯•æ•°æ®åŒæ­¥</button>
                <div id="dataSyncResult" class="result"></div>
            </div>
            <div class="test-item">
                <strong>ç”¨æˆ·çŠ¶æ€æµ‹è¯•</strong>
                <button onclick="testUserStatus()">æµ‹è¯•ç”¨æˆ·çŠ¶æ€</button>
                <div id="userStatusResult" class="result"></div>
            </div>
            <div class="test-item">
                <strong>ç”³è¯·å¤„ç†æµ‹è¯•</strong>
                <button onclick="testApplicationProcessing()">æµ‹è¯•ç”³è¯·å¤„ç†</button>
                <div id="applicationProcessingResult" class="result"></div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>âš ï¸ å‘ç°çš„Bugæ±‡æ€»</h2>
        <div id="bugsSummary">
            <p>ç‚¹å‡»ä¸Šæ–¹æµ‹è¯•æŒ‰é’®å¼€å§‹æ£€æŸ¥...</p>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
        <div id="testLog" class="log"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <button onclick="exportLog()">å¯¼å‡ºæ—¥å¿—</button>
    </div>

    <script>
        class WebsiteTester {
            constructor() {
                this.testResults = [];
                this.bugs = [];
                this.adminToken = null;
                this.memberToken = null;
                this.testMemberId = '1763062451525';
                this.testMemberPassword = 'testnewpass123';
                this.baseURL = window.location.origin;
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}`;
                const logDiv = document.getElementById('testLog');
                const color = {
                    'info': '#17a2b8',
                    'success': '#28a745',
                    'error': '#dc3545',
                    'warning': '#ffc107'
                }[type] || '#666';
                
                logDiv.innerHTML += `<div style="color: ${color}">${logEntry}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }

            updateStats() {
                const total = this.testResults.length;
                const passed = this.testResults.filter(r => r.status === 'success').length;
                const failed = this.testResults.filter(r => r.status === 'error').length;
                const bugs = this.bugs.length;

                document.getElementById('totalTests').textContent = total;
                document.getElementById('passedTests').textContent = passed;
                document.getElementById('failedTests').textContent = failed;
                document.getElementById('bugsFound').textContent = bugs;
            }

            addTestResult(category, testName, status, message, details = '') {
                const result = { category, testName, status, message, details, timestamp: new Date() };
                this.testResults.push(result);
                this.log(`${testName}: ${message}`, status);
                this.updateStats();
                return result;
            }

            addBug(severity, title, description, details = '') {
                const bug = { severity, title, description, details, timestamp: new Date() };
                this.bugs.push(bug);
                this.log(`å‘ç°Bug: ${title} (${severity})`, 'error');
                this.updateBugsSummary();
                return bug;
            }

            updateBugsSummary() {
                const bugsDiv = document.getElementById('bugsSummary');
                if (this.bugs.length === 0) {
                    bugsDiv.innerHTML = '<div class="test-item success">âœ… æš‚æœªå‘ç°ä¸¥é‡Bug</div>';
                    return;
                }

                const criticalBugs = this.bugs.filter(b => b.severity === 'critical');
                const majorBugs = this.bugs.filter(b => b.severity === 'major');
                const minorBugs = this.bugs.filter(b => b.severity === 'minor');

                let html = '';
                
                if (criticalBugs.length > 0) {
                    html += '<h3>ğŸ”´ ä¸¥é‡Bug</h3>';
                    criticalBugs.forEach(bug => {
                        html += `<div class="test-item critical">
                            <strong>${bug.title}</strong><br>
                            ${bug.description}<br>
                            <small>${bug.details}</small>
                        </div>`;
                    });
                }

                if (majorBugs.length > 0) {
                    html += '<h3>ğŸŸ¡ ä¸»è¦Bug</h3>';
                    majorBugs.forEach(bug => {
                        html += `<div class="test-item major">
                            <strong>${bug.title}</strong><br>
                            ${bug.description}<br>
                            <small>${bug.details}</small>
                        </div>`;
                    });
                }

                if (minorBugs.length > 0) {
                    html += '<h3>ğŸŸ£ è½»å¾®Bug</h3>';
                    minorBugs.forEach(bug => {
                        html += `<div class="test-item minor">
                            <strong>${bug.title}</strong><br>
                            ${bug.description}<br>
                            <small>${bug.details}</small>
                        </div>`;
                    });
                }

                bugsDiv.innerHTML = html;
            }

            async testServerConnection() {
                this.log('å¼€å§‹æµ‹è¯•æœåŠ¡å™¨è¿æ¥...', 'info');
                const resultDiv = document.getElementById('serverTestResults');
                
                try {
                    const response = await fetch(`${this.baseURL}/api/data`);
                    if (response.ok) {
                        this.addTestResult('æœåŠ¡å™¨', 'æœåŠ¡å™¨è¿æ¥', 'success', 'æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                        resultDiv.innerHTML = '<div class="test-item success">âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸</div>';
                        return true;
                    } else {
                        this.addTestResult('æœåŠ¡å™¨', 'æœåŠ¡å™¨è¿æ¥', 'error', `æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status}`);
                        resultDiv.innerHTML = `<div class="test-item error">âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${response.status}</div>`;
                        return false;
                    }
                } catch (error) {
                    this.addTestResult('æœåŠ¡å™¨', 'æœåŠ¡å™¨è¿æ¥', 'error', `æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`);
                    this.addBug('critical', 'æœåŠ¡å™¨è¿æ¥å¤±è´¥', 'æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨', error.message);
                    resultDiv.innerHTML = `<div class="test-item error">âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}</div>`;
                    return false;
                }
            }

            async testMemberLogin() {
                this.log('å¼€å§‹æµ‹è¯•ä¼šå‘˜ç™»å½•...', 'info');
                const resultDiv = document.getElementById('memberLoginResult');
                
                try {
                    const response = await fetch(`${this.baseURL}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            memberId: this.testMemberId,
                            password: this.testMemberPassword
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.memberToken = data.user;
                        this.addTestResult('ç”¨æˆ·è®¤è¯', 'ä¼šå‘˜ç™»å½•', 'success', 'ä¼šå‘˜ç™»å½•æˆåŠŸ');
                        resultDiv.innerHTML = '<div class="test-item success">âœ… ä¼šå‘˜ç™»å½•æˆåŠŸ</div>';
                        return true;
                    } else {
                        this.addTestResult('ç”¨æˆ·è®¤è¯', 'ä¼šå‘˜ç™»å½•', 'error', `ä¼šå‘˜ç™»å½•å¤±è´¥: ${data.message}`);
                        resultDiv.innerHTML = `<div class="test-item error">âŒ ä¼šå‘˜ç™»å½•å¤±è´¥: ${data.message}</div>`;
                        return false;
                    }
                } catch (error) {
                    this.addTestResult('ç”¨æˆ·è®¤è¯', 'ä¼šå‘˜ç™»å½•', 'error', `ä¼šå‘˜ç™»å½•å¼‚å¸¸: ${error.message}`);
                    this.addBug('critical', 'ä¼šå‘˜ç™»å½•å¤±è´¥', 'ä¼šå‘˜ç™»å½•åŠŸèƒ½å¼‚å¸¸', error.message);
                    resultDiv.innerHTML = `<div class="test-item error">âŒ ä¼šå‘˜ç™»å½•å¼‚å¸¸: ${error.message}</div>`;
                    return false;
                }
            }

            async testAdminLogin() {
                this.log('å¼€å§‹æµ‹è¯•ç®¡ç†å‘˜ç™»å½•...', 'info');
                const resultDiv = document.getElementById('adminLoginResult');
                
                try {
                    const response = await fetch(`${this.baseURL}/api/admin/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: 'admin',
                            password: 'admin123'
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.adminToken = data.token;
                        this.addTestResult('ç”¨æˆ·è®¤è¯', 'ç®¡ç†å‘˜ç™»å½•', 'success', 'ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
                        resultDiv.innerHTML = '<div class="test-item success">âœ… ç®¡ç†å‘˜ç™»å½•æˆåŠŸ</div>';
                        return true;
                    } else {
                        this.addTestResult('ç”¨æˆ·è®¤è¯', 'ç®¡ç†å‘˜ç™»å½•', 'error', `ç®¡ç†å‘˜ç™»å½•å¤±è´¥: ${data.message}`);
                        resultDiv.innerHTML = `<div class="test-item error">âŒ ç®¡ç†å‘˜ç™»å½•å¤±è´¥: ${data.message}</div>`;
                        return false;
                    }
                } catch (error) {
                    this.addTestResult('ç”¨æˆ·è®¤è¯', 'ç®¡ç†å‘˜ç™»å½•', 'error', `ç®¡ç†å‘˜ç™»å½•å¼‚å¸¸: ${error.message}`);
                    this.addBug('critical', 'ç®¡ç†å‘˜ç™»å½•å¤±è´¥', 'ç®¡ç†å‘˜ç™»å½•åŠŸèƒ½å¼‚å¸¸', error.message);
                    resultDiv.innerHTML = `<div class="test-item error">âŒ ç®¡ç†å‘˜ç™»å½•å¼‚å¸¸: ${error.message}</div>`;
                    return false;
                }
            }

            async testWalletQuery() {
                this.log('å¼€å§‹æµ‹è¯•é’±åŒ…æŸ¥è¯¢...', 'info');
                const resultDiv = document.getElementById('walletQueryResult');
                
                try {
                    const response = await fetch(`${this.baseURL}/api/wallet/${this.testMemberId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.addTestResult('é’±åŒ…åŠŸèƒ½', 'é’±åŒ…æŸ¥è¯¢', 'success', `é’±åŒ…æŸ¥è¯¢æˆåŠŸï¼Œä½™é¢: Â¥${data.wallet.balance}`);
                        resultDiv.innerHTML = `<div class="test-item success">âœ… é’±åŒ…æŸ¥è¯¢æˆåŠŸï¼Œä½™é¢: Â¥${data.wallet.balance}</div>`;
                        return true;
                    } else {
                        this.addTestResult('é’±åŒ…åŠŸèƒ½', 'é’±åŒ…æŸ¥è¯¢', 'error', `é’±åŒ…æŸ¥è¯¢å¤±è´¥: ${data.message}`);
                        resultDiv.innerHTML = `<div class="test-item error">âŒ é’±åŒ…æŸ¥è¯¢å¤±è´¥: ${data.message}</div>`;
                        return false;
                    }
                } catch (error) {
                    this.addTestResult('é’±åŒ…åŠŸèƒ½', 'é’±åŒ…æŸ¥è¯¢', 'error', `é’±åŒ…æŸ¥è¯¢å¼‚å¸¸: ${error.message}`);
                    this.addBug('major', 'é’±åŒ…æŸ¥è¯¢å¤±è´¥', 'é’±åŒ…æŸ¥è¯¢åŠŸèƒ½å¼‚å¸¸', error.message);
                    resultDiv.innerHTML = `<div class="test-item error">âŒ é’±åŒ…æŸ¥è¯¢å¼‚å¸¸: ${error.message}</div>`;
                    return false;
                }
            }

            async testWalletDeposit() {
                this.log('å¼€å§‹æµ‹è¯•é’±åŒ…å……å€¼...', 'info');
                const resultDiv = document.getElementById('walletDepositResult');
                
                try {
                    const response = await fetch(`${this.baseURL}/api/wallet/deposit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: this.testMemberId,
                            amount: 100,
                            description: 'æµ‹è¯•å……å€¼'
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.addTestResult('é’±åŒ…åŠŸèƒ½', 'é’±åŒ…å……å€¼', 'success', `é’±åŒ…å……å€¼æˆåŠŸ: Â¥${data.transaction.amount}`);
                        resultDiv.innerHTML = `<div class="test-item success">âœ… é’±åŒ…å……å€¼æˆåŠŸ: Â¥${data.transaction.amount}</div>`;
                        return true;
                    } else {
                        this.addTestResult('é’±åŒ…åŠŸèƒ½', 'é’±åŒ…å……å€¼', 'error', `é’±åŒ…å……å€¼å¤±è´¥: ${data.message}`);
                        resultDiv.innerHTML = `<div class="test-item error">âŒ é’±åŒ…å……å€¼å¤±è´¥: ${data.message}</div>`;
                        return false;
                    }
                } catch (error) {
                    this.addTestResult('é’±åŒ…åŠŸèƒ½', 'é’±åŒ…å……å€¼', 'error', `é’±åŒ…å……å€¼å¼‚å¸¸: ${error.message}`);
                    this.addBug('major', 'é’±åŒ…å……å€¼å¤±è´¥', 'é’±åŒ…å……å€¼åŠŸèƒ½å¼‚å¸¸', error.message);
                    resultDiv.innerHTML = `<div class="test-item error">âŒ é’±åŒ…å……å€¼å¼‚å¸¸: ${error.message}</div>`;
                    return false;
                }
            }

            async testAll() {
                this.log('å¼€å§‹å…¨é¢æµ‹è¯•...', 'info');
                
                // åŸºç¡€è¿æ¥æµ‹è¯•
                await this.testServerConnection();
                
                // è®¤è¯æµ‹è¯•
                await this.testMemberLogin();
                await this.testAdminLogin();
                
                // é’±åŒ…æµ‹è¯•
                await this.testWalletQuery();
                await this.testWalletDeposit();
                
                this.log('å…¨é¢æµ‹è¯•å®Œæˆ', 'success');
                this.log(`å‘ç° ${this.bugs.length} ä¸ªBugï¼Œ${this.testResults.filter(r => r.status === 'error').length} ä¸ªæµ‹è¯•å¤±è´¥`, 'warning');
            }

            clearLog() {
                document.getElementById('testLog').innerHTML = '';
            }

            exportLog() {
                const logContent = document.getElementById('testLog').innerText;
                const blob = new Blob([logContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `website-test-log-${new Date().toISOString().slice(0, 10)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // åˆå§‹åŒ–æµ‹è¯•å™¨
        const tester = new WebsiteTester();

        // è¿è¡Œå…¨é¢æµ‹è¯•
        window.onload = function() {
            tester.log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            // å¯ä»¥é€‰æ‹©è‡ªåŠ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•
            // tester.testAll();
        };

        // å¯¼å‡ºå‡½æ•°ä¾›æŒ‰é’®è°ƒç”¨
        function testServerConnection() { tester.testServerConnection(); }
        function testMemberLogin() { tester.testMemberLogin(); }
        function testAdminLogin() { tester.testAdminLogin(); }
        function testWalletQuery() { tester.testWalletQuery(); }
        function testWalletDeposit() { tester.testWalletDeposit(); }
        function testAll() { tester.testAll(); }
        function clearLog() { tester.clearLog(); }
        function exportLog() { tester.exportLog(); }
    </script>
</body>
</html>